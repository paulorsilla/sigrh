<?php
$form = $this->form;
$form->get('matricula')->setAttributes([
    'class' => 'form-control',
    'placeholder' => 'Digite a matrícula aqui'
]);

$form->get('nome')->setAttributes([
    'class' => 'form-control',
    'placeholder' => 'Digite o nome aqui'
]);

$form->get('apelido')->setAttributes([
    'class' => 'form-control',
    'placeholder' => 'Digite o apelido aqui'
]);
$form->get('cep')->setAttributes([
    'class' => 'form-control',
    'placeholder' => 'Digite o CEP aqui'
]);

$form->get('endereco')->setAttributes([
    'class' => 'form-control',
    'placeholder' => 'Digite o endereco aqui'
]);

$form->get('numero')->setAttributes([
    'class' => 'form-control',
    'placeholder' => 'Digite o número aqui'
]);

$form->get('complemento')->setAttributes([
    'class' => 'form-control',
    'placeholder' => 'Digite o complemento aqui'
]);

$form->get('bairro')->setAttributes([
    'class' => 'form-control',
    'placeholder' => 'Digite o bairro aqui'
]);

$form->get('cidade')->setAttributes([
    'class' => 'form-control',
]);

$form->get('estado')->setAttributes([
    'class' => 'form-control',
]);

$form->get('submit')->setAttributes([
    'class' => 'btn btn-primary'
]);
?>

<h1>Cadastro de colaboradores</h1>

<div class="row">
    <div class="col-md-22">
        <div class="panel panel-default">
            <div class="panel-heading clearfix">
                <h3 class="panel-title">
                    Por favor, preencha o formulário abaixo e, em seguida, clique sobre
                    o botão <i>Salvar</i>. <a
                        class="btn btn-secondary btn-sm pull-right"
                        href="/sig-rh/colaborador" title="Fechar"><span
                            class="glyphicon glyphicon-remove"></span></a>
                </h3>
            </div>

            <div class="panel-body">
                <?= $this->form()->openTag($form); ?>

                <div class="row">
                    <div class="col-md-2"><?= $this->formRow($form->get('matricula')); ?></div>
                    <div class="col-md-8"><?= $this->formRow($form->get('nome')); ?></div>
                    <div class="col-md-2"><?= $this->formRow($form->get('apelido')); ?></div>
                </div>

                <div class="row">
                </div>
                <hr>

                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#dadosPessoais">Dados Pessoais</a></li>
                    <li><a data-toggle="tab" href="#documentacao">Documentação</a></li>
                </ul>

                <div class="tab-content">
                    <div id="dadosPessoais" class="tab-pane fade in active">
                        <div class="row">
                            <div class="col-md-2"><?= $this->formRow($form->get('cep'));?></div>
                            <div class="col-md-6"><?= $this->formRow($form->get('endereco'));?></div>
                            <div class="col-md-1"><?= $this->formRow($form->get('numero'));?></div>
                            <div class="col-md-3"><?= $this->formRow($form->get('complemento'));?></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6"><?= $this->formRow($form->get('bairro'));?></div>
                            <div class="col-md-2"><?= $this->formRow($form->get('estado'));?></div>
                            <div class="col-md-4"><?= $this->formRow($form->get('cidade'));?></div>
                        </div>
                    </div>

                    <div id="documentacao" class="tab-pane fade">
                        <p>Documentação</p>
                    </div>
                </div>

                <br>
                <br>
                <?= $this->formElement($form->get('submit')); ?>
                <?= $this->form()->closeTag(); ?>
            </div>
        </div>
    </div>
</div>

 <script type="text/javascript" >
       // Carregar as cidades do banco de dados e salvar na variavel vCidades em JSON
        var vCidades = [
            {id:'SP',estado:'Sao Paulo', cidades: [{id:1,cidade:'Sao Paulo'},{id:2,cidade:'Santos'},{id:3,cidade:'Praia Grande'}]},
            {id:'PR',estado:'Parana', cidades: [{id:7,cidade:'Londrina'},{id:8,cidade:'Cambé'}]}
//            'PR': [{id:7,cidade:'Londrina'},{id:8,cidade:'Cambé'}]
        ];
        
//            
        function carregaComboCidades(uf){
            $("select[name=cidade]").html('<option>Selecione</option>');
            $(vCidades).each(function(i,item){
                if (item.id == uf ){
                    achou = false;
                    $(item.cidades).each(function(i2,item2){
                        $("<option></option>").val(item2.id).html(item2.cidade).appendTo($("select[name=cidade]"));
                    });
                }
            });
        }
        function addCidade(uf,nome){
            $(vCidades).each(function(i,item){
                if (item.id == uf ){
                    achou = false;
                    $(item.cidades).each(function(i2,item2){
                        if ( item2.cidade == nome ){
                            achou = true;
                            $("select[name=cidade]").val(item2.id);
                        }
                    });
                    if ( !achou){
                        // fazer uma chamada POST para um action e cadastrar essa cidade retornando o id via json
                        item.cidades.push({id:999,cidade:nome});
                        carregaComboCidades(uf);
                        $("select[name=cidade]").val(999);
                    }
                }
            });
            console.log(achou);
        }
        $(document).ready(function() {

            function limpa_formulário_cep() {
                // Limpa valores do formulário de cep.
                $("input[name=endereco]").val("");
                $("input[name=bairro]").val("");
                $("#cidade").val("");
                $("input[name=estado]").val("");
                $("#ibge").val("");
            }
            $("input[name=estado]").change(function() {
                carregaComboCidades($(this).val());
            });
            //Quando o campo cep perde o foco.
            $("input[name=cep]").change(function() {

                //Nova variável "cep" somente com dígitos.
                var cep = $(this).val().replace(/\D/g, '');

                //Verifica se campo cep possui valor informado.
                if (cep != "") {

                    //Expressão regular para validar o CEP.
                    var validacep = /^[0-9]{8}$/;

                    //Valida o formato do CEP.
                    if(validacep.test(cep)) {

                        //Preenche os campos com "..." enquanto consulta webservice.
//                        $("input[name=endereco]").val("...");
//                        $("input[name=bairro]").val("...");
//                        $("#cidade").val("...");
//                        $("#uf").val("...");
//                        $("#ibge").val("...");

                        //Consulta o webservice viacep.com.br/
                        $.getJSON("//viacep.com.br/ws/"+ cep +"/json/?callback=?", function(dados) {

                            if (!("erro" in dados)) {
                                //Atualiza os campos com os valores da consulta.
                                $("input[name=endereco]").val(dados.logradouro);
                                $("input[name=bairro]").val(dados.bairro);
                                carregaComboCidades(dados.uf);
                                addCidade(dados.uf,dados.localidade);
                                //$("select[name=cidade]").val(dados.localidade);
                                $("input[name=estado]").val(dados.uf);
                                $("#ibge").val(dados.ibge);
                            } //end if.
                            else {
                                //CEP pesquisado não foi encontrado.
                                limpa_formulário_cep();
                                alert("CEP não encontrado.");
                            }
                        });
                    } //end if.
                    else {
                        //cep é inválido.
                        limpa_formulário_cep();
                        alert("Formato de CEP inválido.");
                    }
                } //end if.
                else {
                    //cep sem valor, limpa formulário.
                    limpa_formulário_cep();
                }
            });
        });

</script>